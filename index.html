<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanat Evi Kurs Yönetim Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom Stiller ve Animasyonlar */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        .page { display: none; }
        .page.active { display: block; }
        
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .sidebar-icon {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-icon:hover {
            transform: scale(1.1);
        }
        .status-paid { background-color: #dcfce7; color: #166534; }
        .status-unpaid { background-color: #fee2e2; color: #991b1b; }

        .calendar-slot {
            border: 1px solid #e5e7eb;
            padding: 8px;
            min-height: 80px;
            transition: background-color: 0.2s;
        }
        .calendar-slot.empty {
            background-color: #f9fafb;
            color: #9ca3af;
        }
        .calendar-event {
             cursor: pointer;
        }
        .calendar-event.available {
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
        }
        .calendar-event.full {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }
        .calendar-event.makeup {
            background-color: #fef9c3;
            border-left: 4px solid #f59e0b;
        }


        /* Baskı Stilleri */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Yükleme Ekranı -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
    </div>


    <!-- Firebase Giriş Ekranı -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 id="form-title" class="text-2xl font-bold text-center text-gray-800 mb-6">Yönetici Girişi</h2>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">E-posta Adresi</label>
                    <input type="email" id="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Şifre</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button id="auth-submit-btn" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Giriş Yap</button>
                <p id="auth-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
            </form>
             <div class="mt-4 text-center hidden">
                <a href="#" id="auth-toggle-link" class="text-sm text-indigo-600 hover:underline">Hesabınız yok mu? Kayıt Olun.</a>
            </div>
        </div>
    </div>


    <!-- Ana Uygulama Arayüzü -->
    <div id="app" class="hidden">
        <div class="flex h-screen">
            <!-- Kenar Çubuğu (Sidebar) -->
            <aside class="w-64 bg-gray-800 text-white flex flex-col">
                <div class="h-16 flex items-center justify-center text-2xl font-bold border-b border-gray-700">
                    <i class="fas fa-palette mr-3"></i> Alegori Sanat Evi
                </div>
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="#dashboard" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700 active:bg-indigo-600">
                        <i class="fas fa-tachometer-alt w-6 text-center sidebar-icon"></i><span class="ml-3">Ana Sayfa</span>
                    </a>
                    <a href="#students" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
                        <i class="fas fa-users w-6 text-center sidebar-icon"></i><span class="ml-3">Öğrenciler</span>
                    </a>
                    <a href="#courses" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
                        <i class="fas fa-book w-6 text-center sidebar-icon"></i><span class="ml-3">Kurslar</span>
                    </a>
                    <a href="#payments" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
                        <i class="fas fa-lira-sign w-6 text-center sidebar-icon"></i><span class="ml-3">Ödemeler</span>
                    </a>
                    <a href="#calendar" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
                        <i class="fas fa-calendar-alt w-6 text-center sidebar-icon"></i><span class="ml-3">Ders Programı</span>
                    </a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-button" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">
                        <i class="fas fa-sign-out-alt mr-2"></i> Çıkış Yap
                    </button>
                </div>
            </aside>

            <!-- Ana İçerik -->
            <main class="flex-1 p-6 md:p-10 overflow-y-auto">
                <!-- Sayfa: Ana Sayfa / Dashboard -->
                <div id="dashboard-page" class="page">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Hoş Geldiniz!</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                            <i class="fas fa-users text-4xl text-blue-500"></i>
                            <div class="ml-4">
                                <p class="text-gray-500">Aktif Öğrenci</p>
                                <p id="total-students" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                            <i class="fas fa-book text-4xl text-green-500"></i>
                            <div class="ml-4">
                                <p class="text-gray-500">Aktif Kurs</p>
                                <p id="total-courses" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                            <i class="fas fa-hand-holding-usd text-4xl text-yellow-500"></i>
                            <div class="ml-4">
                                <p class="text-gray-500">Toplam Bakiye</p>
                                <p id="total-balance" class="text-2xl font-bold text-gray-800">0 ₺</p>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-500"></i>
                            <div class="ml-4">
                                <p class="text-gray-500">Borçlu Öğrenci</p>
                                <p id="students-in-debt" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Aktif Kurslar</h2>
                    <div id="dashboard-courses-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Kurs kartları JS ile eklenecek -->
                    </div>
                </div>

                <!-- Sayfa: Öğrenciler -->
                <div id="students-page" class="page">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Öğrenci Yönetimi</h1>
                        <button id="add-student-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 flex items-center">
                            <i class="fas fa-plus mr-2"></i> Yeni Öğrenci Ekle
                        </button>
                    </div>
                    <!-- Arama ve Filtreleme -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-col md:flex-row gap-4">
                        <input type="text" id="student-search" placeholder="Öğrenci adıyla ara..." class="flex-grow p-2 border rounded-md">
                        <select id="student-course-filter" class="p-2 border rounded-md">
                            <option value="">Tüm Kurslar</option>
                        </select>
                        <select id="student-payment-filter" class="p-2 border rounded-md">
                            <option value="">Tüm Ödeme Durumları</option>
                            <option value="paid">Borcu Yok</option>
                            <option value="unpaid">Borçlu</option>
                        </select>
                         <select id="student-status-filter" class="p-2 border rounded-md">
                            <option value="active">Aktif Öğrenciler</option>
                            <option value="inactive">Pasif Öğrenciler</option>
                            <option value="all">Tümü</option>
                        </select>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Ad Soyad (Katılım)</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Kurs</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Ders Günü/Saati</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Bakiye</th>
                                    <th class="p-4 text-center text-sm font-semibold text-gray-600">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body">
                                <!-- Öğrenci listesi JS ile eklenecek -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sayfa: Kurslar -->
                <div id="courses-page" class="page">
                     <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Kurs Yönetimi</h1>
                        <button id="add-course-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 flex items-center">
                            <i class="fas fa-plus mr-2"></i> Yeni Kurs Ekle
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                         <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Kurs Adı</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Eğitmen</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Kontenjan</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Kayıtlı Öğrenci</th>
                                    <th class="p-4 text-center text-sm font-semibold text-gray-600">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="courses-table-body">
                                <!-- Kurs listesi JS ile eklenecek -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sayfa: Ödemeler -->
                <div id="payments-page" class="page">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Ödeme Takibi</h1>
                    <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-col md:flex-row gap-4">
                        <input type="text" id="payment-student-search" placeholder="Öğrenci adıyla ara..." class="flex-grow p-2 border rounded-md">
                        <select id="payment-course-filter" class="p-2 border rounded-md">
                            <option value="">Tüm Kurslar</option>
                        </select>
                        <select id="payment-status-filter" class="p-2 border rounded-md">
                            <option value="">Tüm Ödeme Durumları</option>
                            <option value="unpaid">Borçlu</option>
                            <option value="paid">Borcu Yok</option>
                        </select>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Öğrenci</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Kurs</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Toplam Bakiye</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600">Durum</th>
                                    <th class="p-4 text-center text-sm font-semibold text-gray-600">Ödeme Yap</th>
                                </tr>
                            </thead>
                            <tbody id="payments-table-body">
                                <!-- Ödeme listesi JS ile eklenecek -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sayfa: Ders Programı / Takvim -->
                <div id="calendar-page" class="page">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h1 class="text-3xl font-bold text-gray-800">Ders Programı</h1>
                        <div class="flex items-center gap-2 md:gap-4">
                             <button id="prev-week-btn" title="Önceki Hafta" class="p-2 rounded-md bg-white shadow-sm hover:bg-gray-100"><i class="fas fa-chevron-left"></i></button>
                             <h2 id="week-range-display" class="text-xl md:text-2xl font-bold text-gray-800 text-center"></h2>
                             <button id="next-week-btn" title="Sonraki Hafta" class="p-2 rounded-md bg-white shadow-sm hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
                             <button id="today-btn" class="px-3 py-2 text-sm bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700">Bugün</button>
                        </div>
                        <div class="w-full md:w-64">
                            <select id="calendar-course-filter" class="p-2 border rounded-md w-full"></select>
                       </div>
                    </div>
                    <div class="bg-white p-2 rounded-lg shadow-md">
                        <div id="calendar-grid" class="grid" style="grid-template-columns: 60px repeat(7, 1fr);">
                            <!-- Saatler ve Günler JS ile doldurulacak -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modal (Dinamik İçerik için) -->
    <div id="modal" class="fixed inset-0 z-40 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="flex items-center justify-center min-h-screen">
            <div id="modal-content" class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg transform -translate-y-10">
                <!-- Modal içeriği JS ile doldurulacak -->
            </div>
        </div>
    </div>

    <!-- Yazdırma Alanı (Görünmez) -->
    <div id="print-area" class="hidden"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script type="module">
    // --- ÖNEMLİ: Firebase Proje Ayarlarınızı Buraya Yapıştırın ---
    const firebaseConfig = {
        apiKey: "AIzaSyB9t-ktCl1-AglngKP5gZwmrcDrOw0l0qQ",
        authDomain: "sanatevi-24eb5.firebaseapp.com",
        projectId: "sanatevi-24eb5",
        storageBucket: "sanatevi-24eb5.appspot.com",
        messagingSenderId: "626425182269",
        appId: "1:626425182269:web:15432fbe3362a8c6359254"
    };

    // Firebase'i başlat
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE YÖNETİMİ ---
        let state = {
            students: [],
            courses: []
        };

        let viewDate = new Date();
        
        // --- DOM ELEMENTLERİ ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app');
        const logoutButton = document.getElementById('logout-button');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Auth Form Elements
        const authForm = document.getElementById('auth-form');

        // --- YARDIMCI FONKSİYONLAR ---
        function getWeekInfo(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const weekStart = new Date(date.setDate(diff));
            weekStart.setHours(0, 0, 0, 0);

            const dates = [];
            for (let i = 0; i < 7; i++) {
                const nextDay = new Date(weekStart);
                nextDay.setDate(weekStart.getDate() + i);
                dates.push(nextDay);
            }
            const weekEnd = new Date(dates[6]);
            weekEnd.setHours(23, 59, 59, 999);

            return { weekStart, weekEnd, dates };
        }

        // --- VERİ YÖNETİMİ FONKSİYONLARI ---
        function loadData() {
            loadingOverlay.classList.remove('hidden');

            // Kursları dinle
            db.collection('courses').onSnapshot(snapshot => {
                state.courses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllSelects();
                renderAllPages();
                loadingOverlay.classList.add('hidden');
            }, error => {
                console.error("Kurs verisi alınamadı: ", error);
                loadingOverlay.classList.add('hidden');
            });

            // Öğrencileri dinle
            db.collection('students').onSnapshot(snapshot => {
                state.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllPages();
                loadingOverlay.classList.add('hidden');
            }, error => {
                console.error("Öğrenci verisi alınamadı: ", error);
                loadingOverlay.classList.add('hidden');
            });
        }

        function renderAllPages() {
            const activePage = document.querySelector('.page.active');
            if (!activePage) return;
            showPage(activePage.id.replace('-page', ''));
        }

        function updateAllSelects() {
            updateStudentFilterOptions();
            updatePaymentFilterOptions();
            updateCalendarFilterOptions();
        }

        // --- GÖRÜNÜM (VIEW) FONKSİYONLARI ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(`${pageId}-page`).classList.add('active');
            
            navLinks.forEach(link => {
                link.classList.remove('bg-indigo-600', 'font-bold');
                if (link.getAttribute('href') === `#${pageId}`) {
                    link.classList.add('bg-indigo-600', 'font-bold');
                }
            });

            switch (pageId) {
                case 'dashboard': renderDashboard(); break;
                case 'students': renderStudentsPage(); break;
                case 'courses': renderCoursesPage(); break;
                case 'payments': renderPaymentsPage(); break;
                case 'calendar': renderCalendar(); break;
            }
        }
        
        function renderDashboard() {
            const activeStudents = state.students.filter(s => s.status === 'active');
            let totalBalance = 0;
            let studentsInDebt = 0;
            activeStudents.forEach(s => {
                const balance = (s.payments || []).reduce((sum, p) => sum + p.amount, 0);
                totalBalance += balance;
                if (balance < 0) {
                    studentsInDebt++;
                }
            });

            document.getElementById('total-students').textContent = activeStudents.length;
            document.getElementById('total-courses').textContent = state.courses.length;
            document.getElementById('total-balance').textContent = `${totalBalance.toFixed(2)} ₺`;
            document.getElementById('students-in-debt').textContent = studentsInDebt;
            
            const coursesList = document.getElementById('dashboard-courses-list');
            coursesList.innerHTML = '';
            state.courses.forEach(course => {
                const studentCount = state.students.filter(s => s.courseId === course.id && s.status === 'active').length;
                const card = `
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="xl font-bold text-gray-800">${course.name}</h3>
                        <p class="text-gray-600">Eğitmen: ${course.instructor}</p>
                        <div class="mt-4">
                            <div class="flex justify-between items-center text-sm">
                                <span>Toplam Kayıtlı</span>
                                <span>${studentCount}</span>
                            </div>
                        </div>
                    </div>
                `;
                coursesList.innerHTML += card;
            });
        }
        
        function renderStudentsPage() {
            const filters = {
                name: document.getElementById('student-search').value,
                courseId: document.getElementById('student-course-filter').value,
                paymentStatus: document.getElementById('student-payment-filter').value,
                status: document.getElementById('student-status-filter').value
            };

            const tableBody = document.getElementById('students-table-body');
            tableBody.innerHTML = '';
            
            let filteredStudents = [...state.students];

            if (filters.status && filters.status !== 'all') {
                filteredStudents = filteredStudents.filter(s => s.status === filters.status);
            }

            if (filters.name) {
                filteredStudents = filteredStudents.filter(s => 
                    `${s.firstName} ${s.lastName}`.toLowerCase().includes(filters.name.toLowerCase())
                );
            }
            if (filters.courseId) {
                filteredStudents = filteredStudents.filter(s => s.courseId == filters.courseId);
            }
            if (filters.paymentStatus) {
                filteredStudents = filteredStudents.filter(s => {
                    const balance = (s.payments || []).reduce((sum, p) => sum + p.amount, 0);
                    const isInDebt = balance < 0;
                    return filters.paymentStatus === 'unpaid' ? isInDebt : !isInDebt;
                });
            }


            filteredStudents.forEach(student => {
                const course = state.courses.find(c => c.id === student.courseId);
                const balance = (student.payments || []).reduce((sum, p) => sum + p.amount, 0);
                const attendedCount = (student.attendance || []).filter(a => a.status === 'geldi').length % (student.lessonsPerFee || 1);
                const isInactive = student.status === 'inactive';

                const row = `
                    <tr class="border-b ${isInactive ? 'bg-gray-100 text-gray-500' : ''}">
                        <td class="p-4">
                            <a href="#" class="student-name-link font-semibold hover:underline ${isInactive ? 'text-gray-500' : 'text-indigo-600'}" data-id="${student.id}">${student.firstName} ${student.lastName}</a>
                            <span class="text-sm ml-2">(${attendedCount})</span>
                        </td>
                        <td class="p-4">${course ? course.name : 'Kurs Bulunamadı'}</td>
                        <td class="p-4">${student.day} / ${student.time}</td>
                        <td class="p-4 font-semibold ${balance < 0 ? 'text-red-600' : 'text-green-600'}">${balance.toFixed(2)} ₺</td>
                        <td class="p-4 text-center">
                            <button class="edit-student-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${student.id}" title="Düzenle"><i class="fas fa-edit"></i></button>
                            <button class="delete-student-btn text-red-500 hover:text-red-700 mr-2" data-id="${student.id}" title="Sil"><i class="fas fa-trash"></i></button>
                            <button class="send-student-info-btn text-green-500 hover:text-green-700 mr-2" data-id="${student.id}" title="Gönder"><i class="fas fa-paper-plane"></i></button>
                            <button class="print-student-btn text-gray-500 hover:text-gray-700" data-id="${student.id}" title="Yazdır"><i class="fas fa-print"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        function updateStudentFilterOptions() {
            const courseFilter = document.getElementById('student-course-filter');
            const currentVal = courseFilter.value;
            courseFilter.innerHTML = '<option value="">Tüm Kurslar</option>';
            state.courses.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                courseFilter.appendChild(option);
            });
            courseFilter.value = currentVal;
        }

        function updatePaymentFilterOptions() {
            const courseFilter = document.getElementById('payment-course-filter');
            const currentVal = courseFilter.value;
            courseFilter.innerHTML = '<option value="">Tüm Kurslar</option>';
            state.courses.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                courseFilter.appendChild(option);
            });
            courseFilter.value = currentVal;
        }

        function updateCalendarFilterOptions() {
            const filter = document.getElementById('calendar-course-filter');
            const currentVal = filter.value;
            filter.innerHTML = '';
            state.courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.name;
                filter.appendChild(option);
            });
            if (currentVal && state.courses.some(c => c.id == currentVal)) {
                 filter.value = currentVal;
            }
        }

        function renderCoursesPage() {
            const tableBody = document.getElementById('courses-table-body');
            tableBody.innerHTML = '';
            state.courses.forEach(course => {
                const studentCount = state.students.filter(s => s.courseId === course.id && s.status === 'active').length;
                const row = `
                    <tr class="border-b">
                        <td class="p-4 font-medium">${course.name}</td>
                        <td class="p-4">${course.instructor}</td>
                        <td class="p-4">${course.quota}</td>
                        <td class="p-4">${studentCount}</td>
                        <td class="p-4 text-center">
                            <button class="edit-course-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${course.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-course-btn text-red-500 hover:text-red-700" data-id="${course.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        function renderPaymentsPage(filters = {}) {
             const tableBody = document.getElementById('payments-table-body');
             tableBody.innerHTML = '';
             let studentsToDisplay = [...state.students];

             if (filters.name) {
                studentsToDisplay = studentsToDisplay.filter(s =>
                    `${s.firstName} ${s.lastName}`.toLowerCase().includes(filters.name.toLowerCase())
                );
            }
            if (filters.courseId) {
                studentsToDisplay = studentsToDisplay.filter(s => s.courseId == filters.courseId);
            }
            if (filters.paymentStatus) {
                studentsToDisplay = studentsToDisplay.filter(s => {
                    const balance = (s.payments || []).reduce((sum, p) => sum + p.amount, 0);
                    const isInDebt = balance < 0;
                    return filters.paymentStatus === 'unpaid' ? isInDebt : !isInDebt;
                });
            }

             studentsToDisplay.forEach(student => {
                const course = state.courses.find(c => c.id === student.courseId);
                if (!course) return;

                const balance = (student.payments || []).reduce((sum, p) => sum + p.amount, 0);
                const statusClass = balance >= 0 ? 'status-paid' : 'status-unpaid';
                const statusText = balance >= 0 ? 'Borcu Yok' : 'Borçlu';

                const row = `
                    <tr class="border-b">
                        <td class="p-4">${student.firstName} ${student.lastName}</td>
                        <td class="p-4">${course.name}</td>
                        <td class="p-4 font-bold ${balance < 0 ? 'text-red-600' : 'text-green-600'}">${balance.toFixed(2)} ₺</td>
                        <td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span></td>
                        <td class="p-4 text-center">
                            <button class="add-payment-btn bg-yellow-500 text-white px-3 py-1 rounded shadow hover:bg-yellow-600" data-id="${student.id}">Ödeme Ekle</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
             });
        }
        
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const weekRangeDisplay = document.getElementById('week-range-display');
            grid.innerHTML = '';

            const weekInfo = getWeekInfo(viewDate);
            const { weekStart, weekEnd, dates } = weekInfo;
            const dayNames = ['Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt', 'Paz'];
            const fullDayNames = ['Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi', 'Pazar'];
            const timeSlots = Array.from({ length: 10 }, (_, i) => `${String(i + 9).padStart(2, '0')}:00`);
            const filterCourseId = document.getElementById('calendar-course-filter').value;

            const options = { month: 'short', day: 'numeric' };
            weekRangeDisplay.textContent = `${weekStart.toLocaleDateString('tr-TR', options)} - ${weekEnd.toLocaleDateString('tr-TR', options)} ${weekStart.getFullYear()}`;

            // Header
            grid.innerHTML += `<div class="font-semibold p-2 text-center text-sm"></div>`;
            dates.forEach((date, i) => {
                grid.innerHTML += `<div class="font-semibold p-2 text-center text-sm">${dayNames[i]}<br>${date.getDate()}</div>`;
            });

            const activeStudents = state.students.filter(s => s.status === 'active');
            const allMakeupsThisWeek = activeStudents.flatMap(s => s.attendance || []).filter(a => {
                if (a.status !== 'telafi' || !a.date) return false;
                const makeupDate = new Date(a.date);
                makeupDate.setHours(0,0,0,0);
                return makeupDate >= weekStart && makeupDate <= weekEnd;
            });

            timeSlots.forEach(time => {
                grid.innerHTML += `<div class="font-semibold p-2 text-center text-sm">${time}</div>`;
                dates.forEach((date, i) => {
                    const day = fullDayNames[i];
                    
                    let studentsInSlot = activeStudents.filter(s => s.day === day && s.time === time);
                    let makeupsInSlot = allMakeupsThisWeek.filter(m => {
                        const makeupDate = new Date(m.date);
                        return makeupDate.getDate() === date.getDate() && m.time === time;
                    });
                    
                    if (filterCourseId) {
                        studentsInSlot = studentsInSlot.filter(s => s.courseId == filterCourseId);
                        makeupsInSlot = makeupsInSlot.filter(m => {
                            const student = state.students.find(s => s.id == m.studentId);
                            return student && student.courseId == filterCourseId;
                        });
                    }
                    
                    let slotContentHTML = '';
                    
                    studentsInSlot.forEach(student => {
                        const course = state.courses.find(c => c.id === student.courseId);
                        if (course) {
                            slotContentHTML += `<div class="available calendar-event p-1 rounded mb-1 text-xs border border-blue-200" data-student-id="${student.id}">
                                                <p class="font-bold">${course.name}</p>
                                                <p>${student.firstName}</p>
                                             </div>`;
                        }
                    });
                    
                    makeupsInSlot.forEach(makeup => {
                         const student = state.students.find(s => s.id == makeup.studentId);
                         if (student) {
                             const course = state.courses.find(c => c.id === student.courseId);
                             if (course) {
                                 slotContentHTML += `<div class="makeup calendar-event p-1 rounded mb-1 text-xs border border-yellow-300" data-student-id="${student.id}">
                                                    <p class="font-bold">${course.name} (Telafi)</p>
                                                    <p>${student.firstName}</p>
                                                 </div>`;
                             }
                         }
                    });

                    if (slotContentHTML === '') {
                        grid.innerHTML += `<div class="calendar-slot empty"></div>`;
                    } else {
                        grid.innerHTML += `<div class="calendar-slot p-1 overflow-y-auto">${slotContentHTML}</div>`;
                    }
                });
            });
        }
        
        // --- MODAL FONKSİYONLARI ---
        function showModal(content) {
            modalContent.innerHTML = content;
            modal.classList.remove('hidden');
        }

        function hideModal() {
            modal.classList.add('hidden');
            modalContent.innerHTML = '';
        }
        
        function getStudentFormHTML(student = {}) {
            const isEditing = !!student.id;
            const title = isEditing ? 'Öğrenci Bilgilerini Düzenle' : 'Yeni Öğrenci Ekle';
            let courseOptions = state.courses.map(c => `<option value="${c.id}" ${student.courseId == c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const daysOfWeek = ['Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi', 'Pazar'];
            let dayOptions = daysOfWeek.map(d => `<option value="${d}" ${student.day === d ? 'selected' : ''}>${d}</option>`).join('');
            
            return `
                <h2 class="text-2xl font-bold mb-6">${title}</h2>
                <form id="student-form" data-id="${student.id || ''}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="firstName" placeholder="Ad" value="${student.firstName || ''}" required class="p-2 border rounded">
                        <input type="text" name="lastName" placeholder="Soyad" value="${student.lastName || ''}" required class="p-2 border rounded">
                        <input type="tel" name="phone" placeholder="Telefon" value="${student.phone || ''}" class="p-2 border rounded">
                        <input type="email" name="email" placeholder="E-posta" value="${student.email || ''}" class="p-2 border rounded">
                        <select name="courseId" required class="p-2 border rounded"><option value="">Kurs Seçin...</option>${courseOptions}</select>
                        <input type="date" name="registrationDate" value="${student.registrationDate || new Date().toISOString().slice(0,10)}" required class="p-2 border rounded">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Dönem Ücreti</label>
                            <input type="number" name="fee" placeholder="Ücret (₺)" value="${student.fee || ''}" required class="mt-1 w-full p-2 border rounded">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Ders Sayısı</label>
                            <input type="number" name="lessonsPerFee" placeholder="Ücrete dahil ders" value="${student.lessonsPerFee || '4'}" required class="mt-1 w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ders Günü</label>
                            <select name="day" required class="mt-1 block w-full p-2 border rounded">${dayOptions}</select>
                        </div>
                        <div>
                           <label class="block text-sm font-medium text-gray-700">Ders Saati</label>
                           <input type="time" name="time" value="${student.time || '09:00'}" step="3600" required class="mt-1 block w-full p-2 border rounded">
                        </div>
                    </div>
                    <textarea name="notes" placeholder="Özel Notlar..." class="w-full p-2 border rounded mt-4">${student.notes || ''}</textarea>
                    <p id="form-error" class="text-red-600 text-sm mt-2 text-center h-4"></p>
                    <div class="flex justify-end mt-6 gap-4">
                        <button type="button" id="cancel-modal-btn" class="bg-gray-300 px-4 py-2 rounded">İptal</button>
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">${isEditing ? 'Güncelle' : 'Kaydet'}</button>
                    </div>
                </form>
            `;
        }
        
        function getCourseFormHTML(course = {}) {
            const isEditing = !!course.id;
            const title = isEditing ? 'Kurs Bilgilerini Düzenle' : 'Yeni Kurs Ekle';
            return `
                 <h2 class="text-2xl font-bold mb-6">${title}</h2>
                 <form id="course-form" data-id="${course.id || ''}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="name" placeholder="Kurs Adı" value="${course.name || ''}" required class="p-2 border rounded">
                        <input type="text" name="instructor" placeholder="Eğitmen Adı" value="${course.instructor || ''}" required class="p-2 border rounded">
                    </div>
                     <div class="mt-4">
                         <input type="number" name="quota" placeholder="Kontenjan" value="${course.quota || ''}" required class="w-full p-2 border rounded">
                     </div>
                    <div class="flex justify-end mt-6 gap-4">
                        <button type="button" id="cancel-modal-btn" class="bg-gray-300 px-4 py-2 rounded">İptal</button>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">${isEditing ? 'Güncelle' : 'Kaydet'}</button>
                    </div>
                 </form>
            `;
        }
        
        function getPaymentFormHTML(student) {
            const course = state.courses.find(c => c.id === student.courseId);
            const balance = (student.payments || []).reduce((sum, p) => sum + p.amount, 0);
            
            let paymentHistory = (student.payments || []).map(p => {
                const typeText = p.type === 'initial' ? 'İlk Kayıt' : p.type === 'renewal' ? 'Dönem Yenileme' : 'Ödeme';
                const amountClass = p.amount > 0 ? 'text-green-600' : 'text-red-600';
                return `<li class="flex justify-between py-1 border-b"><span>${new Date(p.date).toLocaleDateString('tr-TR')} - ${typeText}</span><span class="font-semibold ${amountClass}">${p.amount.toFixed(2)} ₺</span></li>`
            }).join('');

            return `
                <h2 class="text-2xl font-bold mb-2">Ödeme İşlemleri</h2>
                <p class="mb-4 text-gray-700">${student.firstName} ${student.lastName} - ${course ? course.name : ''}</p>
                <div class="bg-gray-100 p-4 rounded-lg mb-4">
                    <div class="flex justify-between"><span>Güncel Bakiye:</span> <strong class="${balance < 0 ? 'text-red-600' : 'text-green-600'}">${balance.toFixed(2)} ₺</strong></div>
                </div>
                
                <h3 class="font-bold mb-2 mt-6">İşlem Geçmişi</h3>
                <ul class="mb-6 max-h-32 overflow-y-auto">${paymentHistory}</ul>

                <form id="payment-form" data-id="${student.id}">
                    <div class="flex items-end gap-4">
                        <div class="flex-grow">
                             <label for="payment-amount" class="block text-sm font-medium text-gray-700">Ödeme Tutarı</label>
                             <input type="number" id="payment-amount" name="amount" placeholder="0.00" step="0.01" required class="mt-1 w-full p-2 border rounded">
                        </div>
                        <button type="submit" class="bg-yellow-500 text-white px-4 py-2 rounded h-fit">Ekle</button>
                    </div>
                </form>
                <div class="text-right mt-6">
                    <button type="button" id="cancel-modal-btn" class="bg-gray-300 px-4 py-2 rounded">Kapat</button>
                </div>
            `;
        }
        
        function getStudentStatusModalHTML(student) {
            const balance = (student.payments || []).reduce((sum, p) => sum + p.amount, 0);
            const sessionCount = (student.attendance || []).filter(a => a.status === 'geldi' || a.status === 'gelmedi').length;
            const status = student.status === 'active';

            let attendanceHistory = (student.attendance || []).map(a => {
                let statusText = '';
                if (a.status === 'geldi') {
                    statusText = 'Geldi';
                } else if (a.status === 'gelmedi') {
                    statusText = 'Gelmedi';
                } else if (a.status === 'telafi') {
                    statusText = `Telafi -> ${new Date(a.date).toLocaleDateString('tr-TR')} ${a.time}`;
                }
                const originalDate = a.originalDate ? new Date(a.originalDate).toLocaleDateString('tr-TR') : new Date(a.date).toLocaleDateString('tr-TR');
                return `<li class="flex justify-between py-1 border-b text-sm"><span>${originalDate}</span><span>${statusText}</span></li>`;
            }).join('') || '<p class="text-gray-500 text-sm">Devam kaydı bulunmuyor.</p>';

            return `
                <div class="flex justify-between items-start mb-2">
                    <h2 class="text-2xl font-bold">${student.firstName} ${student.lastName}</h2>
                    <div class="flex items-center gap-2 cursor-pointer" id="toggle-student-status-btn" data-id="${student.id}">
                        <span class="text-sm font-medium ${status ? 'text-green-600' : 'text-red-600'}">${status ? 'Aktif' : 'Pasif'}</span>
                        <div class="relative">
                            <div class="w-10 h-6 rounded-full shadow-inner ${status ? 'bg-green-500' : 'bg-gray-300'}"></div>
                            <div class="absolute w-4 h-4 bg-white rounded-full shadow inset-y-0 left-0 my-1 ml-1 transition-transform duration-200 ease-in-out ${status ? 'transform translate-x-4' : ''}"></div>
                        </div>
                    </div>
                </div>

                <p class="mb-4 text-gray-700">Dönemdeki Ders: ${sessionCount % student.lessonsPerFee} / ${student.lessonsPerFee}</p>
                <div class="bg-gray-100 p-4 rounded-lg mb-4 flex justify-between">
                    <span>Güncel Bakiye:</span> <strong class="${balance < 0 ? 'text-red-600' : 'text-green-600'}">${balance.toFixed(2)} ₺</strong>
                </div>

                <div class="mb-6">
                    <h3 class="font-bold mb-2">Bugünkü Dersi İşle</h3>
                    <div class="flex gap-4">
                        <button id="record-attendance-geldi" data-id="${student.id}" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600">Geldi</button>
                        <button id="record-attendance-gelmedi" data-id="${student.id}" class="flex-1 bg-red-500 text-white py-2 rounded hover:bg-red-600">Gelmedi</button>
                        <button id="record-attendance-telafi-btn" data-id="${student.id}" class="flex-1 bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600">Telafi</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Uyarı: Öğrencinin telafi olan dersini gelmedi olarak işaretlemeyiniz. Mazeretsiz gelmeyenler için 'Gelmedi' olarak işleyiniz.</p>
                </div>

                <form id="telafi-form" class="hidden mt-4 bg-gray-50 p-4 rounded">
                     <h4 class="font-semibold mb-2">Telafi Dersi Planla</h4>
                     <div class="grid grid-cols-2 gap-4">
                         <input type="date" name="telafiDate" required class="p-2 border rounded">
                         <input type="time" name="telafiTime" step="3600" required class="p-2 border rounded">
                     </div>
                     <p id="telafi-form-error" class="text-red-600 text-sm mt-2 text-center h-4"></p>
                     <button type="submit" data-id="${student.id}" class="w-full mt-2 bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Telafiyi Kaydet</button>
                </form>

                <h3 class="font-bold mb-2 mt-6">Devam Geçmişi</h3>
                <ul class="mb-6 max-h-32 overflow-y-auto">${attendanceHistory}</ul>
                
                <div class="text-right mt-6">
                    <button type="button" id="cancel-modal-btn" class="bg-gray-300 px-4 py-2 rounded">Kapat</button>
                </div>
            `;
        }

        function getSendInfoModalHTML(student) {
            return `
                <h2 class="text-2xl font-bold mb-4">"${student.firstName} ${student.lastName}" için Bilgi Gönder</h2>
                <p class="text-gray-600 mb-6">Öğrenci bilgilerini WhatsApp veya E-posta ile göndermek için bir yöntem seçin.</p>
                <p id="send-error" class="text-red-500 text-sm text-center h-4 mb-4"></p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="send-whatsapp-btn" data-id="${student.id}" class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2">
                        <i class="fab fa-whatsapp fa-lg"></i> WhatsApp ile Gönder
                    </button>
                    <button id="send-email-btn" data-id="${student.id}" class="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2">
                        <i class="fas fa-envelope fa-lg"></i> E-posta ile Gönder
                    </button>
                </div>
                <div class="text-right mt-8">
                    <button type="button" id="cancel-modal-btn" class="bg-gray-300 px-4 py-2 rounded">Kapat</button>
                </div>
            `;
        }

        function generateStudentInfoText(studentId) {
            const student = state.students.find(s => s.id == studentId);
            const course = state.courses.find(c => c.id === student.courseId);
            if (!student || !course) return "Öğrenci bilgileri bulunamadı.";

            const balance = (student.payments || []).reduce((sum, p) => sum + p.amount, 0);

            let message = `*Alegori Sanat Evi Bilgilendirme*\n\n`;
            message += `*Öğrenci Bilgileri*\n`;
            message += `Adı Soyadı: ${student.firstName} ${student.lastName}\n`;
            message += `Kurs: ${course.name}\n`;
            message += `Ders Programı: ${student.day} günleri, saat ${student.time}\n\n`;

            message += `*Devam Geçmişi*\n`;
            if (student.attendance && student.attendance.length > 0) {
                student.attendance.forEach(a => {
                    const originalDate = new Date(a.originalDate || a.date).toLocaleDateString('tr-TR');
                    let statusText = '';
                    if (a.status === 'geldi') statusText = 'Geldi';
                    else if (a.status === 'gelmedi') statusText = 'Gelmedi';
                    else if (a.status === 'telafi') statusText = `Telafi -> ${new Date(a.date).toLocaleDateString('tr-TR')} ${a.time}`;
                    message += `- ${originalDate}: ${statusText}\n`;
                });
            } else {
                message += `Devam kaydı bulunmuyor.\n`;
            }
            message += `\n`;

            message += `*Ödeme Geçmişi ve Bakiye*\n`;
            if (student.payments && student.payments.length > 0) {
                student.payments.forEach(p => {
                    const date = new Date(p.date).toLocaleDateString('tr-TR');
                    const type = p.type === 'initial' ? 'İlk Kayıt' : p.type === 'renewal' ? 'Dönem Yenileme' : 'Ödeme';
                    const amount = p.amount.toFixed(2);
                    message += `- ${date}: ${type} (${amount} ₺)\n`;
                });
            } else {
                message += `Ödeme kaydı bulunmuyor.\n`;
            }
            message += `\n*Güncel Bakiye: ${balance.toFixed(2)} ₺*\n`;
            
            return message;
        }

        function generateStudentInfoHTML(studentId) {
            const student = state.students.find(s => s.id == studentId);
            const course = state.courses.find(c => c.id === student.courseId);
            if (!student || !course) return "<p>Öğrenci bilgileri bulunamadı.</p>";

            const balance = (student.payments || []).reduce((sum, p) => sum + p.amount, 0);

            let attendanceHtml = (student.attendance && student.attendance.length > 0)
                ? student.attendance.map(a => {
                    const originalDate = new Date(a.originalDate || a.date).toLocaleDateString('tr-TR');
                    let statusText = '';
                    if (a.status === 'geldi') statusText = 'Geldi';
                    else if (a.status === 'gelmedi') statusText = 'Gelmedi';
                    else if (a.status === 'telafi') statusText = `Telafi -> ${new Date(a.date).toLocaleDateString('tr-TR')} ${a.time}`;
                    return `<tr><td style="padding: 4px;">${originalDate}</td><td style="padding: 4px;">${statusText}</td></tr>`;
                }).join('')
                : '<tr><td colspan="2" style="padding: 4px; color: #888;">Devam kaydı bulunmuyor.</td></tr>';
            
            let paymentsHtml = (student.payments && student.payments.length > 0)
                ? student.payments.map(p => {
                    const date = new Date(p.date).toLocaleDateString('tr-TR');
                    const type = p.type === 'initial' ? 'İlk Kayıt' : p.type === 'renewal' ? 'Dönem Yenileme' : 'Ödeme';
                    const amount = p.amount.toFixed(2);
                    const color = p.amount > 0 ? 'green' : 'red';
                    return `<tr><td style="padding: 4px;">${date}</td><td style="padding: 4px;">${type}</td><td style="padding: 4px; color: ${color}; text-align: right;">${amount} ₺</td></tr>`;
                }).join('')
                : '<tr><td colspan="3" style="padding: 4px; color: #888;">Ödeme kaydı bulunmuyor.</td></tr>';

            const html = `
                <div style="font-family: Arial, sans-serif; padding: 20px; width: 210mm; min-height: 297mm; margin: auto;">
                    <header style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                        <h1>Alegori Sanat Evi</h1>
                        <p>Öğrenci Bilgi Fişi</p>
                    </header>
                    
                    <section style="margin-bottom: 20px;">
                        <h2 style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">Öğrenci Bilgileri</h2>
                        <p><strong>Adı Soyadı:</strong> ${student.firstName} ${student.lastName}</p>
                        <p><strong>Kurs:</strong> ${course.name}</p>
                        <p><strong>Ders Programı:</strong> ${student.day} günleri, saat ${student.time}</p>
                    </section>
                    
                    <section style="margin-bottom: 20px;">
                        <h2 style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">Devam Geçmişi</h2>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr>
                                    <th style="text-align: left; padding: 4px; border-bottom: 1px solid #ddd;">Tarih</th>
                                    <th style="text-align: left; padding: 4px; border-bottom: 1px solid #ddd;">Durum</th>
                                </tr>
                            </thead>
                            <tbody>${attendanceHtml}</tbody>
                        </table>
                    </section>
                    
                    <section>
                        <h2 style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">Ödeme Geçmişi ve Bakiye</h2>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr>
                                    <th style="text-align: left; padding: 4px; border-bottom: 1px solid #ddd;">Tarih</th>
                                    <th style="text-align: left; padding: 4px; border-bottom: 1px solid #ddd;">İşlem</th>
                                    <th style="text-align: right; padding: 4px; border-bottom: 1px solid #ddd;">Tutar</th>
                                </tr>
                            </thead>
                            <tbody>${paymentsHtml}</tbody>
                        </table>
                        <div style="text-align: right; font-size: 18px; font-weight: bold; margin-top: 20px; padding-top: 10px; border-top: 2px solid #333;">
                            Güncel Bakiye: <span style="color: ${balance < 0 ? 'red' : 'green'};">${balance.toFixed(2)} ₺</span>
                        </div>
                    </section>
                </div>
            `;
            return html;
        }

        // --- OLAY YÖNETİCİLERİ (EVENT HANDLERS) ---
        function handleNavigation(e) {
            e.preventDefault();
            if (e.target.closest('.nav-link')) {
                const pageId = e.target.closest('.nav-link').getAttribute('href').substring(1);
                showPage(pageId);
            }
        }
        
        async function handleStudentFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const id = form.dataset.id;
            const formData = new FormData(form);
            const studentData = Object.fromEntries(formData.entries());
            studentData.courseId = studentData.courseId;
            studentData.fee = parseFloat(studentData.fee);
            studentData.lessonsPerFee = parseInt(studentData.lessonsPerFee);

            const course = state.courses.find(c => c.id === studentData.courseId);
            const activeStudents = state.students.filter(s => s.status === 'active');
            const studentsInSlot = activeStudents.filter(s => s.id != id && s.courseId === studentData.courseId && s.day === studentData.day && s.time === studentData.time);

            if (course && studentsInSlot.length >= course.quota) {
                document.getElementById('form-error').textContent = `Bu saat dilimi dolu! (Kontenjan: ${course.quota})`;
                return;
            }
            
            loadingOverlay.classList.remove('hidden');
            try {
                if (id) { 
                    await db.collection('students').doc(id).update(studentData);
                } else { 
                    studentData.payments = [{ amount: -studentData.fee, date: new Date().toISOString(), type: 'initial'}];
                    studentData.attendance = [];
                    studentData.status = 'active';
                    await db.collection('students').add(studentData);
                }
            } catch (error) {
                console.error("Öğrenci kaydedilemedi: ", error);
            } finally {
                loadingOverlay.classList.add('hidden');
                hideModal();
            }
        }

        async function handleCourseFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const id = form.dataset.id;
            const formData = new FormData(form);
            const courseData = Object.fromEntries(formData.entries());
            courseData.quota = parseInt(courseData.quota);

            loadingOverlay.classList.remove('hidden');
            try {
                if (id) {
                    await db.collection('courses').doc(id).update(courseData);
                } else {
                    await db.collection('courses').add(courseData);
                }
            } catch (error) {
                console.error("Kurs kaydedilemedi: ", error);
            } finally {
                loadingOverlay.classList.add('hidden');
                hideModal();
            }
        }
        
        async function handlePaymentFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const studentId = form.dataset.id;
            const amount = parseFloat(form.elements.amount.value);
            const student = state.students.find(s => s.id == studentId);

            if (amount > 0 && student) {
                loadingOverlay.classList.remove('hidden');
                const newPayment = { amount, date: new Date().toISOString(), type: 'payment' };
                const updatedPayments = [...(student.payments || []), newPayment];
                try {
                    await db.collection('students').doc(studentId).update({ payments: updatedPayments });
                } catch(error) {
                    console.error("Ödeme eklenemedi:", error);
                } finally {
                    loadingOverlay.classList.add('hidden');
                    hideModal();
                }
            }
        }
        
        async function handleAttendanceUpdate(studentId, status, details = {}) {
            const student = state.students.find(s => s.id == studentId);
            if (!student) return;

            loadingOverlay.classList.remove('hidden');
            const newAttendance = [...(student.attendance || [])];
            let newPayments = [...(student.payments || [])];
            
            if (status === 'geldi' || status === 'gelmedi') {
                newAttendance.push({ date: new Date().toISOString(), status });

                const sessionCount = newAttendance.filter(a => a.status === 'geldi' || a.status === 'gelmedi').length;
                if (sessionCount > 0 && student.lessonsPerFee > 0 && sessionCount % student.lessonsPerFee === 0) {
                    newPayments.push({ amount: -student.fee, date: new Date().toISOString(), type: 'renewal' });
                }
            } else if (status === 'telafi') {
                const { day, time, date } = details;
                newAttendance.push({ 
                    studentId,
                    status: 'telafi', 
                    originalDate: new Date().toISOString(),
                    date: date,
                    day,
                    time
                });
            }
            
            try {
                await db.collection('students').doc(studentId).update({
                    attendance: newAttendance,
                    payments: newPayments
                });
            } catch (error) {
                console.error("Devam durumu güncellenemedi: ", error);
            } finally {
                loadingOverlay.classList.add('hidden');
                hideModal();
            }
        }
        
        async function handleStudentStatusToggle(studentId) {
            const student = state.students.find(s => s.id == studentId);
            if (student) {
                const newStatus = student.status === 'active' ? 'inactive' : 'active';
                loadingOverlay.classList.remove('hidden');
                try {
                    await db.collection('students').doc(studentId).update({ status: newStatus });
                } catch (error) {
                     console.error("Öğrenci durumu güncellenemedi: ", error);
                } finally {
                    loadingOverlay.classList.add('hidden');
                    hideModal();
                }
            }
        }

        function sendViaWhatsApp(studentId) {
            const student = state.students.find(s => s.id == studentId);
            if (!student || !student.phone) {
                document.getElementById('send-error').textContent = 'Öğrencinin telefon numarası kayıtlı değil.';
                return;
            }
            const message = generateStudentInfoText(studentId);
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/${student.phone}?text=${encodedMessage}`, '_blank');
            hideModal();
        }

        function sendViaEmail(studentId) {
            const student = state.students.find(s => s.id == studentId);
            if (!student || !student.email) {
                document.getElementById('send-error').textContent = 'Öğrencinin e-posta adresi kayıtlı değil.';
                return;
            }
            const message = generateStudentInfoText(studentId);
            const subject = encodeURIComponent('Alegori Sanat Evi - Öğrenci Bilgilendirmesi');
            const body = encodeURIComponent(message);
            window.location.href = `mailto:${student.email}?subject=${subject}&body=${body}`;
            hideModal();
        }

        async function handleTableClicks(e) {
            const calendarEvent = e.target.closest('.calendar-event');
            if (calendarEvent) {
                const studentId = calendarEvent.dataset.studentId;
                const student = state.students.find(s => s.id == studentId);
                if (student) {
                    showModal(getStudentStatusModalHTML(student));
                }
                return;
            }
            
            const target = e.target.closest('button, a');
            if (!target) return;
            
            e.preventDefault();
            const id = target.dataset.id;
            
            if (target.classList.contains('student-name-link')) {
                const student = state.students.find(s => s.id == id);
                if (student) showModal(getStudentStatusModalHTML(student));
            }
            if (target.classList.contains('edit-student-btn')) {
                const student = state.students.find(s => s.id == id);
                if (student) showModal(getStudentFormHTML(student));
            }
            if (target.classList.contains('delete-student-btn')) {
                if (confirm('Bu öğrenciyi kalıcı olarak silmek istediğinizden emin misiniz?')) {
                    loadingOverlay.classList.remove('hidden');
                    await db.collection('students').doc(id).delete();
                    loadingOverlay.classList.add('hidden');
                }
            }
            if (target.classList.contains('send-student-info-btn')) {
                const student = state.students.find(s => s.id == id);
                if (student) showModal(getSendInfoModalHTML(student));
            }
            if (target.classList.contains('print-student-btn')) {
                printStudentInfo(id);
            }
            if (target.classList.contains('edit-course-btn')) {
                const course = state.courses.find(c => c.id == id);
                if (course) showModal(getCourseFormHTML(course));
            }
            if (target.classList.contains('delete-course-btn')) {
                if (confirm('Bu kursu silmek, kayıtlı TÜM öğrencileri de silecektir. Emin misiniz?')) {
                    loadingOverlay.classList.remove('hidden');
                    // İlgili öğrencileri bul ve sil
                    const studentDocs = await db.collection('students').where('courseId', '==', id).get();
                    const batch = db.batch();
                    studentDocs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    // Kursu sil
                    await db.collection('courses').doc(id).delete();
                    loadingOverlay.classList.add('hidden');
                }
            }
            if (target.classList.contains('add-payment-btn')) {
                const student = state.students.find(s => s.id == id);
                if (student) showModal(getPaymentFormHTML(student));
            }
        }

        function printStudentInfo(studentId) {
            const printContent = generateStudentInfoHTML(studentId);
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = printContent;
            window.print();
            printArea.innerHTML = '';
        }

        // --- OLAY DİNLEYİCİLERİ (EVENT LISTENERS) ---
        document.querySelector('aside nav').addEventListener('click', handleNavigation);
        document.getElementById('add-student-btn').addEventListener('click', () => showModal(getStudentFormHTML()));
        document.getElementById('add-course-btn').addEventListener('click', () => showModal(getCourseFormHTML()));
        
        document.getElementById('prev-week-btn').addEventListener('click', () => {
            viewDate.setDate(viewDate.getDate() - 7);
            renderCalendar();
        });
        document.getElementById('next-week-btn').addEventListener('click', () => {
            viewDate.setDate(viewDate.getDate() + 7);
            renderCalendar();
        });
        document.getElementById('today-btn').addEventListener('click', () => {
            viewDate = new Date();
            renderCalendar();
        });

        document.getElementById('student-search').addEventListener('input', renderStudentsPage);
        document.getElementById('student-course-filter').addEventListener('change', renderStudentsPage);
        document.getElementById('student-payment-filter').addEventListener('change', renderStudentsPage);
        document.getElementById('student-status-filter').addEventListener('change', renderStudentsPage);
        
        function applyPaymentFilters() {
            const filters = {
                name: document.getElementById('payment-student-search').value,
                courseId: document.getElementById('payment-course-filter').value,
                paymentStatus: document.getElementById('payment-status-filter').value
            };
            renderPaymentsPage(filters);
        }

        document.getElementById('payment-student-search').addEventListener('input', applyPaymentFilters);
        document.getElementById('payment-course-filter').addEventListener('change', applyPaymentFilters);
        document.getElementById('payment-status-filter').addEventListener('change', applyPaymentFilters);

        document.getElementById('calendar-course-filter').addEventListener('change', renderCalendar);

        modal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-backdrop') || e.target.id === 'cancel-modal-btn') { hideModal(); }
            const studentId = e.target.dataset.id;
            if (e.target.id === 'record-attendance-geldi') { handleAttendanceUpdate(studentId, 'geldi'); }
            if (e.target.id === 'record-attendance-gelmedi') { handleAttendanceUpdate(studentId, 'gelmedi'); }
            if (e.target.id === 'record-attendance-telafi-btn') { document.getElementById('telafi-form').classList.toggle('hidden'); }
            
            if (e.target.closest('#toggle-student-status-btn')) {
                handleStudentStatusToggle(e.target.closest('#toggle-student-status-btn').dataset.id);
            }
            if (e.target.closest('#send-whatsapp-btn')) {
                sendViaWhatsApp(e.target.closest('#send-whatsapp-btn').dataset.id);
            }
            if (e.target.closest('#send-email-btn')) {
                sendViaEmail(e.target.closest('#send-email-btn').dataset.id);
            }
        });
        
        modal.addEventListener('submit', (e) => {
            if (e.target.id === 'telafi-form') {
                e.preventDefault();
                const studentId = e.target.querySelector('button').dataset.id;
                const date = e.target.elements.telafiDate.value;
                const time = e.target.elements.telafiTime.value;
                const days = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
                const dayName = days[new Date(date).getUTCDay()];
                const errorP = document.getElementById('telafi-form-error');
                errorP.textContent = ''; // Clear previous errors

                if (date && time) {
                    const student = state.students.find(s => s.id == studentId);
                    if (!student) return;

                    const course = state.courses.find(c => c.id === student.courseId);
                    if (!course) return;

                    // O saatteki normal dersi olan öğrencileri say
                    const regularStudentsInSlot = state.students.filter(s =>
                        s.status === 'active' &&
                        s.courseId === student.courseId &&
                        s.day === dayName &&
                        s.time === time
                    ).length;

                    // O saate atanmış diğer telafileri say
                    const makeupsInSlot = state.students.flatMap(s => s.attendance || [])
                        .filter(a => {
                            const makeupStudent = state.students.find(st => st.id == a.studentId);
                            return makeupStudent && makeupStudent.status === 'active' &&
                                a.status === 'telafi' &&
                                a.date === date &&
                                a.time === time &&
                                (makeupStudent.courseId === student.courseId);
                        }).length;
                    
                    const totalInSlot = regularStudentsInSlot + makeupsInSlot;

                    if (totalInSlot >= course.quota) {
                        errorP.textContent = `Bu saat dolu! (Kontenjan: ${course.quota})`;
                        return; // Kaydı durdur
                    }

                    handleAttendanceUpdate(studentId, 'telafi', { date, day: dayName, time });
                }
            }
        });


        document.body.addEventListener('submit', (e) => {
            if (e.target.id === 'student-form') handleStudentFormSubmit(e);
            if (e.target.id === 'course-form') handleCourseFormSubmit(e);
            if (e.target.id === 'payment-form') handlePaymentFormSubmit(e);
        });

        document.querySelector('main').addEventListener('click', handleTableClicks);
        
        
        // --- AUTHENTICATION ---
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = authForm.email.value;
            const password = authForm.password.value;
            const errorP = document.getElementById('auth-error');
            errorP.textContent = '';
            loadingOverlay.classList.remove('hidden');

            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    errorP.textContent = 'E-posta veya şifre hatalı.';
                    loadingOverlay.classList.add('hidden');
                });
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        auth.onAuthStateChanged(user => {
            if (user) {
                // Kullanıcı giriş yaptı
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadData();
                showPage('dashboard');
            } else {
                // Kullanıcı çıkış yaptı
                appContainer.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
            }
        });
    });
</script>
</body>
</html>
